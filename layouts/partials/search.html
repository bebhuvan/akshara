<!-- Search Modal -->
<div class="search-modal" id="searchModal">
    <div class="search-modal-content">
        <div class="search-header">
            <div id="search"></div>
            <button class="search-close" onclick="closeSearch()">Ã—</button>
        </div>
    </div>
</div>

<!-- Pagefind Search - Lazy loaded on first open -->
<script>
    let pagefindLoaded = false;

    function loadPagefind() {
        if (pagefindLoaded) return Promise.resolve();

        return new Promise((resolve) => {
            // Load CSS
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/pagefind/pagefind-ui.css';
            document.head.appendChild(link);

            // Load JS
            const script = document.createElement('script');
            script.src = '/pagefind/pagefind-ui.js';
            script.onload = () => {
                new PagefindUI({
                    element: "#search",
                    showSubResults: true,
                    showImages: false,
                    excerptLength: 15
                });
                pagefindLoaded = true;
                resolve();
            };
            document.head.appendChild(script);
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        const searchToggle = document.getElementById('searchToggle');
        const searchModal = document.getElementById('searchModal');

        if (searchToggle) {
            searchToggle.addEventListener('click', openSearch);
        }

        // Keyboard shortcut - press / to open search
        document.addEventListener('keydown', function(e) {
            if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    openSearch();
                }
            }
            if (e.key === 'Escape') {
                closeSearch();
            }
        });

        // Close on overlay click
        searchModal.addEventListener('click', function(e) {
            if (e.target === searchModal) {
                closeSearch();
            }
        });
    });

    function openSearch() {
        const searchModal = document.getElementById('searchModal');
        searchModal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Load Pagefind on first open, then focus
        loadPagefind().then(() => {
            setTimeout(() => {
                const searchInput = document.querySelector('#search input');
                if (searchInput) searchInput.focus();
            }, 100);
        });
    }

    function closeSearch() {
        const searchModal = document.getElementById('searchModal');
        searchModal.classList.remove('active');
        document.body.style.overflow = '';
    }
</script>
